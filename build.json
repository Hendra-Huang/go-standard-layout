{
  "variables": {
    "ansible_host": "go-standard-layout-packer",
    "ansible_connection": "docker",
    "workdir": "{{env `WORKDIR`}}",
    "branch": "{{env `BRANCH`}}",
    "build_version": "{{env `BUILD_VERSION`}}",
    "docker_registry_username": "{{env `DOCKER_USERNAME`}}",
    "docker_registry_password": "{{env `DOCKER_PASSWORD`}}"
  },
  "builders": [
    {
      "type": "docker",
      "image": "golang:1.10-alpine",
      "export_path": "go-standard-layout-packer.tar",
      "run_command": [
        "-d",
        "-i",
        "-t",
        "--name",
        "{{user `ansible_host`}}",
        "{{.Image}}",
        "sh"
      ],
      "changes": [
        "EXPOSE 5555",
        "CMD [\"/usr/local/bin/myappserver\"]"
      ]
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": ["mkdir -p /go/src/github.com/Hendra-Huang/go-standard-layout"]
    },
    {
      "type": "file",
      "source": "{{user `workdir`}}/",
      "destination": "/go/src/github.com/Hendra-Huang/go-standard-layout"
    },
    {
      "type": "ansible",
      "user": "root",
      "playbook_file": "provision.yml"
    }
  ],
  "post-processors": [
    [
      {
        "type": "docker-import",
        "repository": "hendrahuang/go-standard-layout",
        "tag": "{{user `build_version`}}"
      },
      {
        "type": "docker-push",
        "login": true,
        "login_username": "{{user `docker_registry_username`}}",
        "login_password": "{{user `docker_registry_password`}}"
      }
    ],
    [
      {
        "type": "docker-import",
        "repository": "hendrahuang/go-standard-layout",
        "tag": "{{user `branch`}}"
      },
      {
        "type": "docker-push",
        "login": true,
        "login_username": "{{user `docker_registry_username`}}",
        "login_password": "{{user `docker_registry_password`}}"
      }
    ]
  ]
}
